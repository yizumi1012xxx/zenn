---
title: "Lambda@Edgeã‚’CDKã§æ›¸ã„ã¦ã¿ã‚‹"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "CDK", "TypeScript"]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€‚Web ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã® Yuichiro Izumi ã§ã™ã€‚

Lambda@Edge ã‚’ã”å­˜çŸ¥ã§ã™ã‹ï¼Ÿ
Lambda ã§ã§ãã‚‹ã¡ã‚‡ã£ã¨ã—ãŸå‡¦ç†ã‚’ CloudFront ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å®Ÿè¡Œã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚
GA ã‹ã‚‰æ•°å¹´çµŒã¡ã€æœ€è¿‘ã¯è§¦ã‚Œã‚‹æ©Ÿä¼šã‚‚å¢—ãˆã¦ããŸã‹ã¨æ€ã„ã¾ã™ã€‚

https://aws.amazon.com/jp/lambda/edge/

# ä½•ãŒèª²é¡Œã ã£ãŸã‹ï¼Ÿ

CloudFront ã§ Lambda@Edge ã‚’åˆ©ç”¨ã—ãŸã„ã¨ãã‚ã‚Šã¾ã™ã‚ˆã­ã€‚
ãã—ã¦ã€ãã‚Œã‚’ CDK ã§æ›¸ããŸã„ã¨ã„ã†ã¨ãã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

CloudFront ã® Lambda@Edge ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹å ´åˆã€åˆ©ç”¨ã™ã‚‹ Lambda ã¯ã€us-east-1 ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

CDK ã® stack ã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è·¨ã„ã ãƒªã‚½ãƒ¼ã‚¹ã®ç®¡ç†ãŒã§ãã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€Lambda@Edge ç”¨ã® Lambda ã®ã¿ us-east-1 ã§ä½œæˆã—ã€ãã‚Œä»¥å¤–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’ CDK ã§æ„šç›´ã«æ›¸ãå ´åˆã€ï¼’ã¤ã® stack ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã‚“ãªæ™‚ã¯ã€`cloudfront.experimental.EdgeFunction`ã‚’åˆ©ç”¨ã™ã‚‹ã¨ï¼‘ã¤ã® stack ã§ç¶ºéº—ã«æ›¸ã‘ã¾ã—ãŸã€‚

å®Ÿéš›ã¯ã€å‡¦ç†ã®ä¸­ã§æ–°ã—ã„ stack ã‚’ us-east-1 ã«ä½œæˆã—ã¦ã¾ã™ãŒã€é–‹ç™ºè€…ãŒãã‚Œã‚’æ„è­˜ã—ãªã„ã‚ˆã†ã«ãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ã®ãŒã“ã®é–¢æ•°ã®ç‰¹å¾´ã®ã‚ˆã†ã§ã™ã€‚

https://docs.aws.amazon.com/cdk/api/latest/docs/aws-cloudfront-readme.html#lambdaedge

# å®Ÿè£…ä¾‹

`cloudfront.experimental.EdgeFunction`ã‚’åˆ©ç”¨ã—ã¦ã€stack ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ä¸€éƒ¨ã€lambda ã‚„ cloudfront ã‚’ä½œæˆã™ã‚‹éš›ã«å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯çœç•¥ã—ã¦ãŠã‚Šã¾ã™ã€‚
åˆ©ç”¨ã—ãŸ CDK ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 1.95.1 ã§ã—ãŸã€‚

```ts:/bin/infra.ts
#!/usr/bin/env node
import * as cdk from "@aws-cdk/core";
import { SampleStack } from "../lib/sample-stack";

const app = new cdk.App();

new SampleStack(app, "sample-stack", {
  env: {
    account: "xxxxxxxxxxxx",
    region: "ap-northeast-1",
  },
});
```

```ts:/lib/sample-stack.ts
import * as cloudfront from "@aws-cdk/aws-cloudfront";
import * as lambda from "@aws-cdk/aws-lambda";
import * as cdk from "@aws-cdk/core";

export class SampleStack extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, props: cdk.StackProps) {
    super(scope, id, props);

    // NOTE: "src"ã¯å®Ÿéš›ã«deployã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹
    const f = new cloudfront.experimental.EdgeFunction(this, "lambda-edge", {
      code: lambda.Code.fromAsset("src"),
      handler: "index.handler",
      runtime: lambda.Runtime.NODEJS_12_X,
    });
    new cloudfront.CloudFrontWebDistribution(this, "distribution", {
      ...
      originConfigs: [
        {
          behaviors: [
            {
              lambdaFunctionAssociations: [
                {
                  eventType: cloudfront.LambdaEdgeEventType.ORIGIN_REQUEST,
                  lambdaFunction: f.currentVersion,
                },
              ],
            },
          ],
        },
      ],
    });
  }
}
```

# æœ€å¾Œã«

ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã“ã‚Œã§ã€Lambda@Edge ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã§ã‚‚ã€CDK ã§è¨˜è¼‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ç¶­æŒã§ãã¾ã™ã€‚

ã“ã‚Œã‹ã‚‰ã‚‚ã€CDK ã«é–¢ã™ã‚‹ Tips ã‚’ç™ºä¿¡ã—ã¦ã„ã‘ãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚
